<!DOCTYPE html>
<html lang="tr">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Tercih Robotu</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <style>
    body {
      font-family: "Inter", sans-serif;
    }

    /* Custom scrollbar for better aesthetics */
    ::-webkit-scrollbar {
      width: 8px;
    }

    ::-webkit-scrollbar-track {
      background: #1f2937;
    }

    ::-webkit-scrollbar-thumb {
      background: #4b5563;
      border-radius: 10px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: #6b7280;
    }
  </style>
</head>

<body class="bg-gray-900 text-white antialiased">
  <div class="container mx-auto max-w-6xl p-4 sm:p-6 lg:p-8">
    <div class="bg-gray-800 rounded-2xl shadow-2xl p-6 sm:p-8">
      <header class="text-center mb-8">
        <h1 class="text-3xl sm:text-4xl font-bold text-cyan-400">
          Tercih Robotu
        </h1>
        <p class="text-gray-400 mt-2">
          Bilgilerinizi girin, tercihlerinizi yapın ve atama sonuçlarını
          görüntüleyin.
        </p>
      </header>

      <!-- User Input Form -->
      <form id="tercihForm" class="space-y-6">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
          <div>
            <label for="ad" class="block mb-2 text-sm font-medium text-gray-300">Ad</label>
            <input type="text" id="ad" name="ad"
              class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-cyan-500 focus:border-cyan-500 block w-full p-2.5 placeholder-gray-400"
              placeholder="Adınız" required />
          </div>
          <div>
            <label for="soyad" class="block mb-2 text-sm font-medium text-gray-300">Soyad</label>
            <input type="text" id="soyad" name="soyad"
              class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-cyan-500 focus:border-cyan-500 block w-full p-2.5 placeholder-gray-400"
              placeholder="Soyadınız" required />
          </div>
          <div>
            <label for="siralama" class="block mb-2 text-sm font-medium text-gray-300">Sıralama</label>
            <input type="number" max="99999" id="siralama" name="siralama"
              class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-cyan-500 focus:border-cyan-500 block w-full p-2.5 placeholder-gray-400"
              placeholder="Sıralamanız (örn: 1234)" required />
          </div>
        </div>

        <!-- City Preferences -->
        <div>
          <h2 class="text-xl font-semibold mb-4 text-gray-200">
            Şehir Tercihleri (1-40)
          </h2>
          <div id="tercihListesi" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4">
            <!-- Preference selects will be generated here by JS -->
          </div>
        </div>

        <!-- 41st Preference Checkbox -->
        <div class="flex items-center mt-6">
          <input id="tercih41" name="tercih41" type="checkbox"
            class="w-5 h-5 text-cyan-600 bg-gray-700 border-gray-600 rounded focus:ring-cyan-500 focus:ring-offset-gray-800" />
          <label for="tercih41" class="ml-3 text-sm font-medium text-gray-300">41. tercihi (boşta kalan herhangi bir
            kadro) yapmak
            istiyorum.</label>
        </div>

        <!-- Action Buttons -->
        <div class="flex flex-col sm:flex-row items-center justify-center gap-4 pt-4">
          <button type="submit"
            class="w-full sm:w-auto text-white bg-cyan-600 hover:bg-cyan-700 focus:ring-4 focus:outline-none focus:ring-cyan-800 font-medium rounded-lg text-sm px-8 py-3 text-center transition-colors duration-200">
            Kaydet
          </button>
          <button type="button" id="atamaYapBtn"
            class="w-full sm:w-auto text-white bg-green-600 hover:bg-green-700 focus:ring-4 focus:outline-none focus:ring-green-800 font-medium rounded-lg text-sm px-8 py-3 text-center transition-colors duration-200">
            Atamayı Yap
          </button>
          <button type="button" id="temizleBtn"
            class="w-full sm:w-auto text-white bg-red-600 hover:bg-red-700 focus:ring-4 focus:outline-none focus:ring-red-800 font-medium rounded-lg text-sm px-8 py-3 text-center transition-colors duration-200">
            Tüm Verileri Temizle
          </button>
        </div>
      </form>

      <div id="toast-message"
        class="hidden fixed top-5 right-5 flex items-center w-full max-w-xs p-4 text-gray-500 bg-white rounded-lg shadow dark:text-gray-400 dark:bg-gray-800"
        role="alert"></div>

      <!-- Results Section -->
      <div id="sonuclar" class="mt-12">
        <h2 class="text-2xl font-semibold mb-4 text-center text-gray-200">
          Atama Sonuçları
        </h2>
        <div id="sonucTablosu" class="overflow-x-auto relative shadow-md sm:rounded-lg">
          <!-- Results table will be generated here by JS -->
          <p class="text-gray-500 text-center">Henüz atama yapılmadı.</p>
        </div>
      </div>
    </div>
  </div>
  <!-- Firebase SDK -->

  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-database-compat.js"></script>

  <script>
    // Firebase init üstte, sonra tüm main kod DOMContentLoaded içinde çalışacak
    const firebaseConfig = {
      apiKey: "AIzaSyDMm0mG1WG8mysaYxvGuX2Dj6W3XAy_o70",
      authDomain: "bt-tercih.firebaseapp.com",
      databaseURL: "https://bt-tercih-default-rtdb.firebaseio.com",
      projectId: "bt-tercih",
      storageBucket: "bt-tercih.firebasestorage.app",
      messagingSenderId: "308852832889",
      appId: "1:308852832889:web:5516509352c49792fa72a8",
    };
    firebase.initializeApp(firebaseConfig);
  </script>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      // ---------- DOM elemanları ----------
      const tercihForm = document.getElementById("tercihForm");
      const tercihListesiDiv = document.getElementById("tercihListesi");
      const atamaYapBtn = document.getElementById("atamaYapBtn");
      const sonucTablosuDiv = document.getElementById("sonucTablosu");
      const temizleBtn = document.getElementById("temizleBtn");

      // ---------- Şehirler ve kontenjanlar (orjinal) ----------
      const sehirler = [
        "Adıyaman", "Ağrı", "Ardahan", "Artvin", "Batman", "Bayburt", "Bingöl", "Bitlis", "Çankırı", "Diyarbakır", "Elazığ", "Erzincan", "Erzurum", "Gaziantep", "Giresun", "Gümüşhane", "Hakkari", "Hatay", "Iğdır", "İstanbul", "Kahramanmaraş", "Kars", "Kastamonu", "Kayseri", "Kırşehir", "Kilis", "Malatya", "Mardin", "Muş", "Nevşehir", "Niğde", "Ordu", "Rize", "Siirt", "Sivas", "Şanlıurfa", "Şırnak", "Tokat", "Tunceli", "Van", "Yozgat",
      ];

      const kontenjanlar = {
        İstanbul: 19, Şanlıurfa: 7, Hatay: 5, Gaziantep: 4, Diyarbakır: 4, Van: 3, Kahramanmaraş: 3,
        Erzurum: 3, Tokat: 3, Ordu: 2, Mardin: 2, Yozgat: 2, Adıyaman: 2, Malatya: 2, Elazığ: 2,
        Nevşehir: 2, Şırnak: 2, Kars: 2, Kastamonu: 2, Niğde: 2, Hakkari: 2, Ağrı: 1, Muş: 1, Giresun: 1,
        Sivas: 1, Kayseri: 1, Bitlis: 1, Siirt: 1, Artvin: 1, Batman: 1, Ardahan: 1, Kırşehir: 1,
        Erzincan: 1, Çankırı: 1, Rize: 1, Kilis: 1, Bayburt: 1, Gümüşhane: 1, Tunceli: 1, Iğdır: 1,
        Bingöl: 1,
      };

      // ---------- showToast (orijinal ikonlu versiyon) ----------
      const showToast = (message, type = "success") => {
        const toast = document.getElementById("toast-message");
        const colorClasses = {
          success: {
            icon: '<svg class="w-5 h-5" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 20 20"><path d="M10 .5a9.5 9.5 0 1 0 9.5 9.5A9.51 9.51 0 0 0 10 .5Zm3.707 8.207-4 4a1 1 0 0 1-1.414 0l-2-2a1 1 0 0 1 1.414-1.414L9 10.586l3.293-3.293a1 1 0 0 1 1.414 1.414Z"/></svg>',
            text: "text-green-500 dark:text-green-400",
            bg: "bg-green-100 dark:bg-green-800",
          },
          error: {
            icon: '<svg class="w-5 h-5" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 20 20"><path d="M10 .5a9.5 9.5 0 1 0 9.5 9.5A9.51 9.51 0 0 0 10 .5ZM10 15a1 1 0 1 1 0-2 1 1 0 0 1 0 2Zm1-4a1 1 0 0 1-2 0V6a1 1 0 0 1 2 0v5Z"/></svg>',
            text: "text-red-500 dark:text-red-400",
            bg: "bg-red-100 dark:bg-red-800",
          },
        };

        toast.innerHTML = `
                <div class="inline-flex items-center justify-center flex-shrink-0 w-8 h-8 ${colorClasses[type].text} ${colorClasses[type].bg} rounded-lg">
                    ${colorClasses[type].icon}
                    <span class="sr-only">${type} icon</span>
                </div>
                <div class="ml-3 text-sm font-normal">${message}</div>
            `;
        toast.classList.remove("hidden");
        setTimeout(() => {
          toast.classList.add("hidden");
        }, 3000);
      };

      // ---------- Tercih select'lerini oluştur ----------
      function populateTercihler() {
        const tercihContainer = tercihListesiDiv;
        tercihContainer.innerHTML = "";

        for (let i = 1; i <= 40; i++) {
          const select = document.createElement("select");
          select.name = `tercih${i}`;
          select.classList.add(
            "bg-gray-700",
            "border",
            "border-gray-600",
            "text-white",
            "text-sm",
            "rounded-lg",
            "focus:ring-cyan-500",
            "focus:border-cyan-500",
            "block",
            "w-full",
            "p-2.5",
            "placeholder-gray-400",
            "transition-colors",
            "duration-200",
            "mb-2"
          );

          const emptyOption = document.createElement("option");
          emptyOption.value = "";
          emptyOption.textContent = `${i}. Tercih (Boş bırakılabilir)`;
          select.appendChild(emptyOption);

          sehirler.forEach((sehir) => {
            const option = document.createElement("option");
            option.value = sehir;
            const kont = kontenjanlar[sehir] || 0;
            option.textContent = `${sehir} ${kont > 0 ? `(Kontenjan: ${kont})` : "(Dolu)"}`;
            option.disabled = kont === 0;
            select.appendChild(option);
          });

          // 🔹 Aynı şehir fazla seçilirse engelle
          select.addEventListener("change", () => {
            const selectedValues = Array.from(
              tercihContainer.querySelectorAll("select")
            ).map((s) => s.value);

            sehirler.forEach((sehir) => {
              const count = selectedValues.filter((v) => v === sehir).length;
              const maxAllowed = kontenjanlar[sehir] || 0;

              // Eğer zaten kontenjan 0 ise seçilemezdi; burada maxAllowed>0 ise limit kontrolü
              if (maxAllowed > 0 && count > maxAllowed) {
                // Kullanıcının son yaptığı seçimi geri al: seçimi boş yap
                select.value = "";
                showToast(`${sehir} en fazla ${maxAllowed} kez seçilebilir!`, "error");
              }
            });
          });

          tercihContainer.appendChild(select);
        }
      }

      populateTercihler();

      // ---------- Export to Excel (orijinal) ----------
      function exportToExcel(sonuclar) {
        const data = sonuclar.map((s, i) => ({
          "Sıra No": i + 1,
          "Ad Soyad": s.kullanici.ad + " " + s.kullanici.soyad,
          Sıralama: s.kullanici.siralama,
          "Atandığı Şehir": s.atandigiSehir,
          "Kaçıncı Tercih": s.tercihSirasi || "-",
          "41. Tercih": (s.kullanici.tercih41 ? 'Evet' : ''),
          "İlk 5 Tercih": (s.kullanici.tercihler || []).slice(0, 5).join(", "),
        }));
        const ws = XLSX.utils.json_to_sheet(data);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Atama Sonuçları");
        XLSX.writeFile(wb, "AtamaSonuclari.xlsx");
      }

      // ---------- Chart modal ----------
      function showChart(sonuclar) {
        const allPrefs = {};
        sonuclar.forEach((s) => {
          (s.kullanici.tercihler || []).forEach((pref) => {
            allPrefs[pref] = (allPrefs[pref] || 0) + 1;
          });
        });
        const sorted = Object.entries(allPrefs).sort((a, b) => b[1] - a[1]);
        const labels = sorted.map((x) => x[0]);
        const values = sorted.map((x) => x[1]);

        const modal = document.getElementById("chartModal");
        modal.classList.remove("hidden");

        // --- Chart.js Bar Chart ---
        const ctx = document.getElementById("tercihChart").getContext("2d");
        if (window._tercihChartInstance) window._tercihChartInstance.destroy();
        window._tercihChartInstance = new Chart(ctx, {
          type: "bar",
          data: {
            labels,
            datasets: [{
              label: "En Çok Tercih Edilen İller",
              data: values,
              backgroundColor: "rgba(34, 211, 238, 0.6)",
              borderColor: "rgba(34, 211, 238, 1)",
              borderWidth: 1,
            }],
          },
          options: {
            responsive: true,
            scales: { y: { beginAtZero: true } },
          },
        });

        // --- ECharts Türkiye Haritası ---
        const mapDom = document.getElementById("turkiyeMap");
        const mapChart = echarts.init(mapDom);

        // Türkiye haritası geo verisi (ECharts resmi kaynak)
        fetch("tr.geojson")
          .then((res) => res.json())
          .then((turkeyJson) => {

            const geoNames = turkeyJson.features.map((f) =>
              f.properties.name
            );

            // Verilerdeki şehir adlarını da aynı şekilde normalize et
            const data = Object.keys(allPrefs).map((sehir) => {
              const normalized = sehir;
              // GeoJSON içinde eşleşen ismi bul
              const matchedName =
                geoNames.find((g) => g.includes(normalized) || normalized.includes(g)) ||
                sehir;
              return { name: matchedName, value: allPrefs[sehir] };
            });


            echarts.registerMap("TURKEY", turkeyJson);

            const option = {
              tooltip: {
                trigger: "item",
                formatter: (p) => {
                  return `${p.name}: ${p.value || 0} tercih`; 
                },
              },
              visualMap: {
                left: "right",
                min: 0,
                max: Math.max(...values) || 1,
                inRange: { color: ["#55ff78", "#f1dd38", "#ff7f00", "#ff5578"] },
                text: ["Fazla", "Az"],
                calculable: true,
                textStyle: { color: "#fff" },
              },
              series: [
                {
                  name: "Tercih Sayısı",
                  type: "map",
                  map: "TURKEY",
                  roam: true,
                  emphasis: { label: { show: true } },
                  data,
                },
              ],
            };


            mapChart.setOption(option);
            window.addEventListener("resize", () => mapChart.resize());
          });
      }

      // modal close
      document.getElementById("closeChart").addEventListener("click", () => {
        document.getElementById("chartModal").classList.add("hidden");
      });

      // ---------- Atama ve Temizle (orijinal mantık korunarak) ----------
      atamaYapBtn.addEventListener("click", () => {
        firebase
          .database()
          .ref("kullanicilar")
          .once("value")
          .then((snapshot) => {
            const kullanicilarObj = snapshot.val() || {};
            // transform to array of {key, ...}
            const kullanicilar = Object.keys(kullanicilarObj).map(k => ({ key: k, ...kullanicilarObj[k] }));

            if (kullanicilar.length === 0) {
              showToast("Atama yapılacak kayıtlı kullanıcı bulunamadı.", "error");
              sonucTablosuDiv.innerHTML =
                '<p class="text-gray-500 text-center">Atama yapılacak kayıtlı kullanıcı bulunamadı.</p>';
              return;
            }

            // sort by siralama
            kullanicilar.sort((a, b) => a.siralama - b.siralama);

            const atamalar = {}; // şehir bazında listeler (şehir => [kullanici...])
            const sonucListesi = [];
            const atanamayanlar41 = [];

            for (const kullanici of kullanicilar) {
              let atandi = false;

              for (const tercihSehir of kullanici.tercihler || []) {
                const sehirKontenjani = kontenjanlar[tercihSehir] || 0;
                const mevcutAtamaSayisi = atamalar[tercihSehir]?.length || 0;

                if (sehirKontenjani === 0) continue; // kontenjan yoksa geç
                if (mevcutAtamaSayisi >= sehirKontenjani) continue; // kontenjan dolmuşsa geç

                // Atama yapılabilir
                if (!atamalar[tercihSehir]) atamalar[tercihSehir] = [];
                atamalar[tercihSehir].push(kullanici);
                const tercihIndex = (kullanici.tercihler || []).indexOf(tercihSehir) + 1;
                sonucListesi.push({
                  kullanici,
                  atandigiSehir: tercihSehir,
                  tercihSirasi: tercihIndex,
                });

                atandi = true;
                break;
              }

              if (!atandi) {
                if (kullanici.tercih41) atanamayanlar41.push(kullanici);
                else
                  sonucListesi.push({
                    kullanici,
                    atandigiSehir: "Atanamadı",
                  });
              }
            }

            // 41. tercih işleme
            for (const kullanici of atanamayanlar41) {
              const bosSehirler = sehirler.filter((s) => {
                const kont = kontenjanlar[s] || 0;
                const mevcut = atamalar[s]?.length || 0;
                return kont > 0 && mevcut < kont;
              });

              if (bosSehirler.length > 0) {
                const atanacakSehir = bosSehirler[Math.floor(Math.random() * bosSehirler.length)];
                if (!atamalar[atanacakSehir]) atamalar[atanacakSehir] = [];
                atamalar[atanacakSehir].push(kullanici);
                sonucListesi.push({
                  kullanici,
                  atandigiSehir: atanacakSehir,
                  tercihSirasi: 41,
                });
              } else {
                const randomSehir = sehirler[Math.floor(Math.random() * sehirler.length)];
                sonucListesi.push({
                  kullanici,
                  atandigiSehir: `${randomSehir} (Ek Kontenjan)`,
                });
              }
            }

            // sort sonuçları kullanıcı.siralama göre
            sonucListesi.sort((a, b) => a.kullanici.siralama - b.kullanici.siralama);

            // display
            displaySonuclar(sonucListesi);
          });
      });

      temizleBtn.addEventListener("click", () => {
        const sifre = prompt("Verileri silmek için şifreyi girin:");
        if (sifre === "bt-tercih42") {
          if (confirm("Tüm kayıtlı kullanıcı verilerini silmek istediğinizden emin misiniz? Bu işlem geri alınamaz.")) {
            firebase
              .database()
              .ref("kullanicilar")
              .remove()
              .then(() => showToast("Tüm Firebase verileri silindi.", "success"))
              .catch(() => showToast("Silme işleminde hata oluştu!", "error"));

            sonucTablosuDiv.innerHTML = '<p class="text-gray-500 text-center">Tüm veriler temizlendi.</p>';
          }
        } else if (sifre !== null) {
          showToast("Şifre yanlış!", "error");
        }
      });

      // ---------- Sonuç gösterme (orijinal) ----------
      const displaySonuclar = (sonuclar) => {
        if (sonuclar.length === 0) {
          sonucTablosuDiv.innerHTML =
            '<p class="text-gray-500 text-center">Atama sonucu bulunamadı.</p>';
          return;
        }
        let tableHTML = `
                <table class="w-full text-sm text-left text-gray-400">
                    <thead class="text-xs uppercase bg-gray-700 text-gray-400">
                        <tr>
                            <th scope="col" class="px-6 py-3">Sıra No</th>
                            <th scope="col" class="px-6 py-3">Ad Soyad</th>
                            <th scope="col" class="px-6 py-3">Sıralaması</th>
                            <th scope="col" class="px-6 py-3">Atandığı Şehir</th>
                            <th scope="col" class="px-6 py-3">Kaçıncı Tercih</th>
                            <th scope="col" class="px-6 py-3">41. Tercih</th>
                            <th scope="col" class="px-6 py-3">İlk 5 Tercihi</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
        sonuclar.forEach((sonuc, index) => {
          tableHTML += `
                    <tr class="border-b bg-gray-800 border-gray-700 hover:bg-gray-600">
                        <th scope="row" class="px-6 py-4 font-medium whitespace-nowrap text-white">${index + 1}</th>
                        <td class="px-6 py-4">${sonuc.kullanici.ad} ${sonuc.kullanici.soyad}</td>
                        <td class="px-6 py-4">${sonuc.kullanici.siralama}</td>
                        <td class="px-6 py-4 font-bold ${sonuc.atandigiSehir.startsWith("Atanamadı") ? "text-red-500" : "text-cyan-400"}">
                            ${sonuc.atandigiSehir}
                        </td>
                        <td class="px-6 py-4">${sonuc.tercihSirasi || "-"}</td>
                        <td class="px-6 py-4">${sonuc.kullanici.tercih41 ? 'Evet' : ''}</td>
                        <td class="px-6 py-4 text-gray-300">${(sonuc.kullanici.tercihler || []).slice(0, 5).join(", ")}</td>
                    </tr>
                `;
        });
        tableHTML += "</tbody></table>";
        sonucTablosuDiv.innerHTML = tableHTML;

        // extra action buttons
        const actionButtons = document.createElement("div");
        actionButtons.classList.add("flex", "justify-center", "gap-4", "mt-6");

        const excelBtn = document.createElement("button");
        excelBtn.textContent = "Excel'e Aktar";
        excelBtn.className = "bg-yellow-500 hover:bg-yellow-600 text-white px-6 py-2 rounded-lg transition-colors duration-200";

        const chartBtn = document.createElement("button");
        chartBtn.textContent = "Tercih Grafiğini Göster";
        chartBtn.className = "bg-purple-600 hover:bg-purple-700 text-white px-6 py-2 rounded-lg transition-colors duration-200";

        excelBtn.addEventListener("click", () => exportToExcel(sonuclar));
        chartBtn.addEventListener("click", () => showChart(sonuclar));

        sonucTablosuDiv.appendChild(actionButtons);
        actionButtons.appendChild(excelBtn);
        actionButtons.appendChild(chartBtn);

        showToast("Atama işlemi tamamlandı!", "success");
      };

      // ---------- Firebase destekli güncelleme: siralama ile yükleme ve formu doldurma ----------
      let currentUserKey = null;

      const siralamaInput = document.getElementById("siralama");
      siralamaInput.addEventListener("change", (e) => {
        const val = parseInt(e.target.value);
        if (!val) {
          currentUserKey = null;
          return;
        }

        firebase.database().ref("kullanicilar")
          .orderByChild("siralama")
          .equalTo(val)
          .once("value")
          .then(snapshot => {
            if (!snapshot.exists()) {
              showToast("Bu sıralamaya ait kayıt bulunamadı.", "error");
              currentUserKey = null;
              return;
            }

            const dataObj = snapshot.val();
            const keys = Object.keys(dataObj);
            const key = keys[0];
            const data = dataObj[key];

            // formu doldur
            document.getElementById("ad").value = data.ad || "";
            document.getElementById("soyad").value = data.soyad || "";
            document.getElementById("siralama").value = data.siralama || "";

            // tercih checkbox
            document.getElementById("tercih41").checked = !!data.tercih41;

            // tercih select'lerini doldur
            const selects = Array.from(tercihListesiDiv.querySelectorAll("select"));
            selects.forEach(s => s.value = "");
            (data.tercihler || []).forEach((tercih, idx) => {
              if (idx < selects.length) {
                selects[idx].value = tercih;
              }
            });

            currentUserKey = key;
            showToast("Kayıt yüklendi. Düzenleyip Kaydet butonuna basın.", "success");
          })
          .catch(err => {
            console.error("Firebase sorgu hatası:", err);
            showToast("Kayıt yüklenirken hata oldu.", "error");
          });
      });

      // ---------- Kaydet (Yeni / Güncelleme) ----------
      tercihForm.addEventListener("submit", (e) => {
        e.preventDefault();
        const formData = new FormData(tercihForm);
        const tercihler = [];

        for (let i = 1; i <= 40; i++) {
          const tercih = formData.get(`tercih${i}`);
          if (tercih) tercihler.push(tercih);
        }

        const yeniKullanici = {
          ad: formData.get("ad"),
          soyad: formData.get("soyad"),
          siralama: parseInt(formData.get("siralama")),
          tercihler,
          tercih41: formData.get("tercih41") === "on",
        };

        if (currentUserKey) {
          // Güncelleme: ama önce aynı siralama numarasına sahip başka bir kayıt var mı kontrol et
          firebase
            .database()
            .ref("kullanicilar")
            .orderByChild("siralama")
            .equalTo(yeniKullanici.siralama)
            .once("value")
            .then(snapshot => {
              const exists = snapshot.exists();
              if (exists) {
                const data = snapshot.val();
                const keys = Object.keys(data);

                // Eğer sorgu bize sadece kendi kaydımızı döndürdü ise devam edebiliriz
                if (!(keys.length === 1 && keys[0] === currentUserKey)) {
                  showToast("Bu sıralama başka bir kullanıcı tarafından kullanılıyor!", "error");
                  return;
                }
              }

              // Güncelleme işlemi
              firebase.database().ref("kullanicilar/" + currentUserKey)
                .set(yeniKullanici)
                .then(() => {
                  showToast("Kullanıcı başarıyla güncellendi!", "success");
                })
                .catch(() => showToast("Güncelleme sırasında hata oluştu!", "error"));
            })
            .catch(err => {
              console.error("Firebase sorgu hatası:", err);
              showToast("Güncelleme öncesi kontrol hatası.", "error");
            });

        } else {
          // Yeni kayıt: önce aynı siralama kontrolü
          firebase
            .database()
            .ref("kullanicilar")
            .orderByChild("siralama")
            .equalTo(yeniKullanici.siralama)
            .once("value")
            .then((snapshot) => {
              if (snapshot.exists()) {
                showToast(
                  "Bu sıralamada başka bir kullanıcı zaten kayıtlı!",
                  "error"
                );
                return;
              }

              firebase
                .database()
                .ref("kullanicilar")
                .push(yeniKullanici)
                .then(() =>
                  showToast("Kullanıcı başarıyla kaydedildi!", "success")
                )
                .catch(() =>
                  showToast("Firebase kaydı sırasında hata oluştu!", "error")
                );

              tercihForm.reset();
              currentUserKey = null;
            });
        }
      });

      // ---------- İlk yüklemede sonuç / chart script'leri globalde lazım, ama tanımlandı ----------
      // Hepsi üstte tanımlı olduğundan burada sorun yok.
    });
  </script>

  <!-- dış scriptler (excel, chart) -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/echarts@5.5.0/dist/echarts.min.js"></script>


  <div id="chartModal" class="fixed inset-0 bg-black bg-opacity-70 hidden flex justify-center items-center z-50 p-4">
    <div
      class="bg-gray-800 p-6 sm:p-8 rounded-2xl w-full max-w-6xl relative shadow-2xl transform transition-all scale-100">
      <button id="closeChart" class="absolute top-3 right-3 text-gray-400 hover:text-white text-lg">
        ✕
      </button>
      <h2 class="text-xl sm:text-2xl font-semibold text-center text-cyan-400 mb-4">
        En Çok Tercih Edilen İller
      </h2>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div class="w-full overflow-x-auto">
          <canvas id="tercihChart" class="w-full h-64 sm:h-80"></canvas>
        </div>
        <div id="turkiyeMap" class="w-full h-64 sm:h-80 rounded-lg"></div>
      </div>
    </div>
  </div>


</body>

</html>